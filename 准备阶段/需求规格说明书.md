# 基于python的英语发音例句库接口：需求规格说明书

**Python课程设计小组：张一鸣，张晓艺，潘昊**

**组长：张一鸣**

## 文档修改记录

| 版本号 | 版本描述                       | 责任人 | 日期      | 备注 |
| ------ | ------------------------------ | ------ | --------- | ---- |
| V1.0   | 初始编制                       | 张一鸣 | 2020-5-4  |      |
| V1.1   | 完善内容                       | 张一鸣 | 2020-6-9  |      |
| V1.2   | 移除用户定制的讳词过滤功能     | 张一鸣 | 2020-6-11 |      |
| V1.3   | 修改影片例句表结构             | 张一鸣 | 2020-6-11 |      |
| V1.4   | 电影例句表的s_id键添加自动递增 | 张一鸣 | 2020-6-11 |      |
| V1.5   | 添加了json的传输形式  | 张一鸣  | 2020-6-16 | |
| V1.6   | 添加影片自动裁切模块分析数据规定  | 张一鸣  | 2020-6-29 | |
| V1.6   | 添加配置文件有关的注意事项  | 张一鸣  | 2020-6-30 | |

## 第一章 引言

### 1.1 定位与目标

随着社会发展，受教育人数逐渐提升，对英语类学习软件的需求亦逐年递增。但是，辅助英语学习的例句库却始终被各家独占。小的开发者团体只能购买权威词典的例句，其虽然发音标准，但朗读人员少、内容乏味且缺少生活化表达。为解决这类问题，提高学生学习兴趣，我们希望能够分析英文电影中的句子，并将其按照单词归类成例句库，供开发者调用。

## 1.2 对象

**本《软件需求规格说明书》的预期读者是：**

- 项目审核教师
- 项目组所有人员
- 测试组人员

## 2.需求概述

本接口的基本目标是满足各英语学习软件对英语例句的需求，为了满足开发人员灵活使用，应做到以下几点要求：

1. 例句输入数据库时，应对其进行筛查，并尽量过滤满足以下情况的例句：
   1. 例句较短、对上下文有要求等没有实用价值的。
   2. 例句中含有不雅词汇的。
   3. 例句非目标语言，即非英语的。
2. 用户请求得到例句时，可以选择其难度。
3. 为提高用户体验，接口响应时间应不超过300ms。

### 2.1 系统结构

![](https://www.z4a.net/images/2020/06/13/06b9a5e9840aced1b339645ad8bde436.png)

## 3. 系统功能需求

## 3.1 功能总览

| 功能         | 具体描述                             | 使用此功能的系统角色 |
| ------------ | ------------------------------------ | -------------------- |
| 查询单词释义 | 包括词性和中文释义                   | 开发人员             |
| 得到例句     | 包括中文和英文例句。可以选择例句难度 | 开发人员             |
| 得到例句音频 | 返回音频存储地址                     | 开发人员             |

### 3.2 业务流程图

![](https://www.z4a.net/images/2020/06/13/bbbdbe9236d2ecb89ad3a5ef9dbc4465.png)

### 3.3 数据流图

![](https://www.z4a.net/images/2020/06/13/6b1633aa1ebc4803eddc674786c34f3c.png)

### 3.4 数据字典

**用户表(t_user)**

| 编号 | 字段名称 | 字段含义 | 字段类型 | 字段长度 | 是否主键 | 默认值 | 是否可空 |
| ---- | -------- | -------- | -------- | -------- | -------- | ------ | -------- |
| 1    | u_name   | 用户名   | Varchar  | 20       | √        |        | ×        |
| 2    | u_key    | 密钥     | Varchar  | 128      |          |        | ×        |



**单词表(t_word)**

| 编号 | 字段名称    | 字段含义                   | 字段类型 | 字段长度 | 是否主键 | 默认值 | 是否可空 |
| ---- | ----------- | -------------------------- | -------- | -------- | -------- | ------ | -------- |
| 1    | word        | 单词                       | Varchar  | 50       | √        |        | ×        |
| 2    | translation | 中文翻译                   | Text     |          |          |        | ×        |
| 3    | sentences   | 例句（例句id，用“\|”分隔） | Text     | --       |          |        | ×        |



**影片例句表(t_sentence)**

| 编号 | 字段名称 | 字段含义           | 字段类型 | 字段长度 | 是否主键 | 默认值 | 是否可空 |
| ---- | -------- | ------------------ | -------- | -------- | -------- | ------ | -------- |
| 1    | s_id     | 例句id（自动递增） | Integer  | 7        | √        |        | ×        |
| 2    | s_en     | 英文原版例句       | Text     |          |          |        | ×        |
| 3    | s_cn     | 中文翻译例句       | Text     |          |          |        | ×        |
| 4    | s_voice  | 音频文件地址       | Varchar  | 100      |          |        | √        |
| 5    | s_level  | 难度分级（0-2）    | Integer  | 1        |          | 2      | ×        |
| 6    | f_name   | 电影名称           | Varchar  | 100      |          |        | ×        |

### 3.5 E-R图

![](https://www.z4a.net/images/2020/06/13/af75f02c856815a13ed918c1982e984c.png)

**用户表E-R图**

![](https://www.z4a.net/images/2020/06/13/6641358b8390efa79bc1b68084747c4a.png)

**单词表E-R图**

![](https://www.z4a.net/images/2020/06/13/a355db4cedc5edd5a4b9b79754ea2ad8.png)

**影片例句表E-R图**

### 3.6 传输范例

**用户发送**
```json
{
    "security":{
        "uname":"用户名",
        "key":"MD5(key+时间戳)",
        "time": 0.0
    },
    "word":"查询单词",
    "option":{
        "level":0,
        "count":5
    }
}
```
注：
1. time格式为时间戳，最多精确到小数点后7位。
1. md5使用UTF-8编码加密，加密结果位16位小写字符。
1. level为例句难度，分类标准为：

    | 值 | 描述 |
    | --- | --- |
    | 0 | 简单 |
    | 1 | 中等 |
    | 2 | 困难 |
    | 3 | 以上全部 |
    
1. count为返回例句数量，过多例句可能导致响应时间过长。


**用户接收**
```json
{
    "statue":0,
    "word":"查询单词",
    "trans":"中文释义",
    "sentences":[
        {
            "fname":"电影名",
            "en":"英文原版例句",
            "cn":"中文翻译例句",
            "voice":"音频文件地址"
        },
        {
            "fname":"电影名",
            "en": "英文原版例句",
            "cn": "中文翻译例句",
            "voice": "音频文件地址"
        }
    ]
}
```
注：

1. statue状态码的值有：

    | 状态码 | 含义 |
    | ---- | -------- |
    | 0    | 请求成功        |
    | 1    | 请求单词未录入   |
    | 2    | 用户认证失败     |
    | 3    | 传入数据格式错误  |
    
1. 返回例句使用无压缩的UTF-8编码。

### 3.7 影片自动裁切模块分析数据规定

> 注：“影片自动裁切模块”在下文中简称为“裁切模块”。

#### 3.7.1 字幕文件

字幕文件仅支持**srt格式**，且必须同时具有中英双语翻译，其单句示例如下：

```
12
00:00:21,510 --> 00:00:22,660
他好像不太高兴
He doesn't seem happy.
```

文件由多个以上示例单句组成，第一行为字幕内部id，第二行为持续时间，第三行为中文翻译，第二行为英文原句。每段字幕直接使用一行隔开。

#### 3.7.2 视频文件

视频文件必须为mp4格式且与字幕文件同名（拓展名不同）并与其在同一个目录下。

#### 3.7.3 配置文件

裁切模块使用配置文件进行常用配置的更改，其格式如下：

```xml
<?xml version="1.0" encoding="utf-8" ?>
<setting>
    <description>
        <app>pyfilm-spliter</app>
        <ver>1.0</ver>
    </description>
    <path>
        <caption_path>这里填写字幕与对应视频的目录</caption_path>
        <audio_path>这里填写音频输出目录</audio_path>
    </path>
    <database>
        <server>数据库地址</server>
        <user>数据库用户名</user>
        <password>数据库密码</password>
        <db_name>数据库名</db_name>
    </database>
</setting>
```

**注意：**

1. 字幕与对应视频需要放在同一个目录。
1. 数据库中应有一个名为enwords的表，此表有英语单词对应的释义，且此表中的单词量应为分析后t_words表的超集，否则t_words表不会增加单词。
1. 将此xml文件命名为**setting.xml并保存在program.py同级目录下**即可。

#### 3.7.4 输出音频

输出的音频文件为**mp3**格式，比特率固定为124kbps，位深16bit。

单个文件大小视例句长度而定，一般不会大于100kb。

#### 3.7.5 运行报告

不管程序是否正常运行，裁切模块都会在当前目录中生成运行报告，其文件名为`runtime_doc.txt`

1. 若程序正常运行，则会在报告结尾生成成功提示，示例如下：

    ```
    date:Mon Jun 29 03:04:49 2020
    ================================================
    Done!
    word_count:	10635
    sentence_count:	47581
    All data have been uploaded in database.
    $END$
    ```

    程序将在报告中写明退出时间、分析词汇量和例句量。

1. 若程序在运行中出现异常，则会在报告中出现警告内容，示例如下

    ```
    date:Mon Jun 29 11:22:37 2020
    ================================================
    Warning!
    警告内容：	视频裁切模块错误
    错误类型str(Exception):	<class 'Exception'>
    友好提示str(e):	t_start (22.46) should be smaller than the clip's duration (1.00).
    详细错误类型repr(e):	ValueError("t_start (22.46) should be smaller than the clip's duration (1.00).")
    traceback.print_exc():	None
    异常链traceback.format_exc():
    Traceback (most recent call last):
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\analyser\caption_factory.py", line 93, in __build_sentence_list
        audio_file = film_spliter.spliter.Spliter.split_to_mp3(source_film, target_audio, caption)
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\film_spliter\spliter.py", line 13, in split_to_mp3
        film_clip = film_clip.subclip(t_start=str(caption.start_tick), t_end=str(caption.end_tick))
      File "<decorator-gen-36>", line 2, in subclip
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\moviepy\decorators.py", line 89, in wrapper
        return f(*new_a, **new_kw)
      File "<decorator-gen-35>", line 2, in subclip
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\moviepy\decorators.py", line 29, in apply_to_mask
        newclip = f(clip, *a, **k)
      File "<decorator-gen-34>", line 2, in subclip
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\moviepy\decorators.py", line 41, in apply_to_audio
        newclip = f(clip, *a, **k)
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\moviepy\Clip.py", line 385, in subclip
        raise ValueError("t_start (%.02f) " % t_start +
    ValueError: t_start (22.46) should be smaller than the clip's duration (1.00).
    
    ```

    一份报告中可能不只有一处警告内容，此警告是否影响程序继续运行需查看报告结尾的提示来判断。

1. 若在程序中出现了无法处理的异常，为保证后续工作正常进行，程序被迫退出，则在文档结尾生成的内容示例如下：

    ```
    date:Mon Jun 29 11:30:13 2020
    ================================================
    Exception Happened:
    错误类型str(Exception):	<class 'Exception'>
    友好提示str(e):	(2003, "Can't connect to MySQL server on '127.0.0.1' ([WinError 10061] 由于目标计算机积极拒绝，无法连接。)")
    详细错误类型repr(e):	OperationalError(2003, "Can't connect to MySQL server on '127.0.0.1' ([WinError 10061] 由于目标计算机积极拒绝，无法连接。)")
    traceback.print_exc():	None
    异常链traceback.format_exc():
    Traceback (most recent call last):
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\pymysql\connections.py", line 581, in connect
        sock = socket.create_connection(
      File "c:\users\zhang\appdata\local\programs\python\python38-32\lib\socket.py", line 808, in create_connection
        raise err
      File "c:\users\zhang\appdata\local\programs\python\python38-32\lib\socket.py", line 796, in create_connection
        sock.connect(sa)
    ConnectionRefusedError: [WinError 10061] 由于目标计算机积极拒绝，无法连接。
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "C:/Users/zhang/PycharmProjects/pyfilm-spliter/program.py", line 7, in <module>
        an = Analyser()
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\analyser\analyser.py", line 52, in __init__
        raise e
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\analyser\analyser.py", line 49, in __init__
        raise e
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\analyser\analyser.py", line 38, in __init__
        dm = data_connector.data_manager.DataManager(self.__db_setting)
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\data_connector\data_manager.py", line 11, in __init__
        self.__connection = self.build_connection()
      File "C:\Users\zhang\PycharmProjects\pyfilm-spliter\data_connector\data_manager.py", line 15, in build_connection
        return pymysql.connect(self.__server, self.__user, self.__password, self.__database)
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\pymysql\__init__.py", line 94, in Connect
        return Connection(*args, **kwargs)
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\pymysql\connections.py", line 325, in __init__
        self.connect()
      File "C:\Users\zhang\django_basic_venv\lib\site-packages\pymysql\connections.py", line 630, in connect
        raise exc
    pymysql.err.OperationalError: (2003, "Can't connect to MySQL server on '127.0.0.1' ([WinError 10061] 由于目标计算机积极拒绝，无法连接。)")
    
    ```
   
   若出现此类异常，请先排除异常再运行程序。

## 4. 软硬件及外部系统接口需求

### 4.1 硬件需求

理论上可以在任何运行Python且接入网络的设备运行，但是设备运算能力过低会延长系统响应时间，影响用户体验。

## 4.3 运行环境

开发环境为Python 3.8.1，低于此版本可能引起运行故障。

## 5. 可靠性与可用性需求

### 5.1 性能需求

1. 处理能力

   暂未进行不同性能环境下的实验，但是鉴于本接口属于目标应用高度常用的类型，推测对性能要求较高，使其具备高并发的稳定性环境。

2. 响应时间

   为了给用户良好的体验，综合网络上已知的经验及数据，响应时间不得高于300ms。

### 5.2 安全性需求

由于单条数据价值不高，不对传输过程中的数据进行加密，但是应对接入用户进行判断，防止未认证的用户接入。

---

参考文献：

1. 《软件需求规格说明书范例》来源

   https://www.omegaxyz.com/2019/07/23/software-specification/

2. 《软件工程导论》张海藩 牟永敏著
